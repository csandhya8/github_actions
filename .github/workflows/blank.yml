
name: GRE Deploy (Build With Parameters - Checkboxes)

on:
  workflow_dispatch:
    inputs:
      cmoptaccounttypecallreason_inbound_rt:
        type: boolean
        description: cmoptaccounttypecallreason.inbound.rt
        required: false
        default: false
      cmoptitss_inbound_rt:
        type: boolean
        description: cmoptitss.inbound.rt
        required: false
        default: false
      cmoptrxspecialitycampaignname_inbound_rt:
        type: boolean
        description: cmoptrxspecialitycampaignname.inbound.rt
        required: false
        default: false
      cmoptrxspecialityclientname_inbound_rt:
        type: boolean
        description: cmoptrxspecialityclientname.inbound.rt
        required: false
        default: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      selected_json: ${{ steps.collect.outputs.selected_json }}
    steps:
      - name: Collect checked servers into JSON array
        id: collect
        shell: bash
        run: |
          set -euo pipefail

          declare -a selected=()

          [[ "${{ inputs.cmoptaccounttypecallreason_inbound_rt }}" == "true" ]] && selected+=("cmoptaccounttypecallreason.inbound.rt")
          [[ "${{ inputs.cmoptitss_inbound_rt }}" == "true" ]] && selected+=("cmoptitss.inbound.rt")
          [[ "${{ inputs.cmoptrxspecialitycampaignname_inbound_rt }}" == "true" ]] && selected+=("cmoptrxspecialitycampaignname.inbound.rt")
          [[ "${{ inputs.cmoptrxspecialityclientname_inbound_rt }}" == "true" ]] && selected+=("cmoptrxspecialityclientname.inbound.rt")

          if [[ "${#selected[@]}" -eq 0 ]]; then
            echo "ERROR: No servers selected. Please tick at least one checkbox." >&2
            exit 2
          fi

          # Convert bash array -> JSON array
          selected_json=$(printf '%s\n' "${selected[@]}" | jq -Rc '[splits("\n") | map(select(length>0))[]]')
          echo "selected_json=${selected_json}" >> "$GITHUB_OUTPUT"

          echo "### Selected servers" >> "$GITHUB_STEP_SUMMARY"
          echo "${selected_json}" | jq -r '.[]' | sed 's/^/- /' >> "$GITHUB_STEP_SUMMARY"

  deploy:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        server: ${{ fromJSON(needs.prepare.outputs.selected_json) }}
    steps:
      - name: Deploy to ${{ matrix.server }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Deploying to: ${{ matrix.server }}"
          # TODO: Add your deployment logic (SSH, API calls, etc.)
          # Example:
          # ssh -o StrictHostKeyChecking=no user@${{ matrix.server }} "sudo systemctl restart gre-service"
